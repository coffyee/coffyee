<!DOCTYPE html>
<html>

<head>
    <title>Music Sync Client</title>
</head>

<body>
    <h1>Music Sync Client</h1>
    <audio id="audio" controls></audio>
    <script>
        let socket;
        const audio = document.getElementById('audio');
        let filePath;

        // Prompt user for IP address
        const serverIp = prompt("Enter the server IP address (e.g., 192.168.1.84):");

        if (serverIp) {
            const wsUrl = `wss://${serverIp}:7070`;
            console.log(`Connecting to WebSocket server at ${wsUrl}`);
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('Connected to the server.');
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                alert('Failed to connect to the server. Check the IP address and server status.');
            };

            socket.onclose = () => {
                console.log('Disconnected from the server.');
            };

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'click') {
                    try {
                        if (data.filePath !== filePath) {
                            audio.src = data.url;
                            filePath = data.filePath;
                            await audio.load();
                        }
                        console.log('Source of audio', audio.src);
                    } catch (error) {
                        console.error('Select audio failed:', error);
                    }
                } else if (data.type === 'sync') {
                    try {
                        if (data.filePath !== filePath) {
                            audio.src = data.url;
                            filePath = data.filePath;
                            await audio.load();
                        }
                        const syncPosition = data.position / 1000; // Convert milliseconds to seconds
                        audio.currentTime = syncPosition;

                        if (audio.paused) {
                            await audio.play();
                        }
                        console.log(`Synced to position: ${syncPosition}s`);
                    } catch (error) {
                        console.error('Playback sync failed:', error);
                    }
                } else if (data.type === 'play') {
                    try {
                        if (audio.paused) await audio.play();
                        console.log('Playing Song');
                    } catch (error) {
                        console.error('Play failed:', error);
                    }
                } else if (data.type === 'pause') {
                    try {
                        await audio.pause();
                        console.log('Paused Song');
                    } catch (error) {
                        console.error('Pause failed:', error);
                    }
                }
            };
        } else {
            alert('No IP address provided. Please refresh and enter a valid IP.');
        }
    </script>
</body>

</html>